<!DOCTYPE html>
<html>
<head>
  <title>AWS Cost & Resource Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h2>AWS Cost & Resource Dashboard</h2>

  <input id="accessKey" placeholder="AWS Access Key" /><br><br>
  <input id="secretKey" placeholder="AWS Secret Key" type="password" /><br><br>
  <input id="region" placeholder="Region (default: us-east-1)" /><br><br>

  <button onclick="getResources()">Get Resources</button>
  <button onclick="getCost()">Get Cost</button>

  <pre id="output"></pre>

  <h3>Resource Usage</h3>
  <canvas id="resourceChart" width="400" height="200"></canvas>

  <h3>Cost Breakdown</h3>
  <canvas id="costChart" width="400" height="200"></canvas>

  <script>
    // IMPORTANT: Must match your port-forward command
    const apiBase = "http://localhost:8081";

    let resourceChart = null;
    let costChart = null;

    async function getResources() {
      const body = {
        access_key: document.getElementById("accessKey").value,
        secret_key: document.getElementById("secretKey").value,
        region: document.getElementById("region").value || "us-east-1"
      };

      try {
        const res = await fetch(`${apiBase}/resources`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const err = await res.text();
          throw new Error(err);
        }

        const data = await res.json();
        document.getElementById("output").innerText = JSON.stringify(data, null, 2);
        renderResourceChart(data);
      } catch (error) {
        document.getElementById("output").innerText = "Error: " + error.message;
      }
    }

    async function getCost() {
      const body = {
        access_key: document.getElementById("accessKey").value,
        secret_key: document.getElementById("secretKey").value,
        region: document.getElementById("region").value || "us-east-1"
      };

      try {
        const res = await fetch(`${apiBase}/cost`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });

        if (!res.ok) {
          const err = await res.text();
          throw new Error(err);
        }

        const data = await res.json();
        document.getElementById("output").innerText = JSON.stringify(data, null, 2);
        renderCostChart(data);
      } catch (error) {
        document.getElementById("output").innerText = "Error: " + error.message;
      }
    }

    function renderResourceChart(data) {
      const ctx = document.getElementById("resourceChart").getContext("2d");
      if (resourceChart) resourceChart.destroy();

      resourceChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: ["EC2 Instances", "S3 Buckets"],
          datasets: [{
            label: "Count",
            data: [data.ec2_instances, data.s3_buckets]
          }]
        }
      });
    }

    function renderCostChart(data) {
      const ctx = document.getElementById("costChart").getContext("2d");
      if (costChart) costChart.destroy();

      costChart = new Chart(ctx, {
        type: "pie",
        data: {
          labels: Object.keys(data),
          datasets: [{
            label: "Cost ($)",
            data: Object.values(data)
          }]
        }
      });
    }
  </script>
</body>
</html>
